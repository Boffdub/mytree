# Rebuild web app and update docs/ on push to main (so GitHub Pages stays in sync).
# Runs when you push source changes; does not run when the only changes are in docs/
# (e.g. the commit this workflow pushes).
name: Deploy web to GitHub Pages

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.gitignore'

jobs:
  deploy-web:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # so we can push the updated docs/

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Export web build
        run: npx expo export --platform web

      - name: Update docs from dist
        run: |
          rm -rf docs/_expo docs/assets docs/favicon.ico docs/index.html docs/metadata.json
          cp -r dist/_expo dist/assets dist/favicon.ico dist/index.html dist/metadata.json docs/
          touch docs/.nojekyll

      - name: Commit and push docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git diff --staged --quiet || git commit -m "chore: rebuild web for GitHub Pages [automated]"
          git push origin main
